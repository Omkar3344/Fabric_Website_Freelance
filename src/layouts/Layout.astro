---
import "../styles/globals.css";
import Navbar from "../components/Navbar.astro";

const {
    title = "Fabric Loom | Premium Fabrics for Every Occasion",
    description = "Discover curated textiles tailored for celebrations, couture, everyday comfort, and bespoke interiors.",
    ogImage = "/assets/og-default.jpg",
    structuredData,
} = Astro.props;
---
<!doctype html>
<html lang="en" class="scroll-smooth bg-[#fefae0] text-slate-900">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content={description} />
        <meta name="generator" content={Astro.generator} />
        <title>{title}</title>
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <meta property="og:title" content={title} />
        <meta property="og:description" content={description} />
        <meta property="og:type" content="website" />
        <meta property="og:image" content={ogImage} />
        <meta name="theme-color" content="#ccd5ae" />
        {structuredData && (
            <script type="application/ld+json" is:inline>
                {JSON.stringify(structuredData)}
            </script>
        )}
    </head>
    <body class="min-h-screen font-['Inter',sans-serif] text-slate-800 selection:bg-[#ccd5ae] selection:text-slate-900">
        <a href="#main-content" class="sr-only focus:not-sr-only focus:absolute focus:left-4 focus:top-4 focus:rounded-md focus:bg-[#fefae0] focus:px-4 focus:py-2 focus:text-slate-900 focus:shadow">
            Skip to content
        </a>
    <Navbar />
    <main id="main-content" class="flex flex-1 flex-col" data-main-shell>
            <slot />
        </main>
    <footer class="border-t border-[#e9edc9]/80 bg-[#e9edc9]">
            <div class="mx-auto grid max-w-6xl gap-8 px-4 py-10 md:grid-cols-4 md:px-6">
                <div>
                    <a href="/" class="text-lg font-semibold text-[#d4a373]">Fabric Loom</a>
                    <p class="mt-3 text-sm text-slate-600">
                        Luxury and everyday textiles crafted with precision, sustainability, and a designer’s touch.
                    </p>
                </div>
                <div>
                    <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-700">Explore</h3>
                    <ul class="mt-3 space-y-2 text-sm text-slate-600">
                        <li><a href="/#collections" class="transition hover:text-[#d4a373]">Collections</a></li>
                        <li><a href="/products#filters" class="transition hover:text-[#d4a373]">Fabric Categories</a></li>
                        <li><a href="/about#process" class="transition hover:text-[#d4a373]">Craftsmanship</a></li>
                        <li><a href="/contact#showroom" class="transition hover:text-[#d4a373]">Visit us</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-700">Contact</h3>
                    <ul class="mt-3 space-y-2 text-sm text-slate-600">
                        <li>+91 98765 43210</li>
                        <li><a href="mailto:hello@fabricloom.com" class="transition hover:text-[#d4a373]">hello@fabricloom.com</a></li>
                        <li>Mon – Sat, 9:30 AM – 7:30 PM IST</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-sm font-semibold uppercase tracking-wide text-slate-700">Newsletter</h3>
                    <form class="mt-3 space-y-3">
                        <label class="block text-xs font-medium uppercase tracking-wide text-slate-500">
                            Be the first to view new arrivals
                            <input
                                type="email"
                                required
                                placeholder="Email address"
                                class="mt-2 w-full rounded-md border border-[#e9edc9] bg-white px-3 py-2 text-sm text-slate-800 placeholder:text-slate-400 focus:border-[#d4a373] focus:outline-none focus:ring-2 focus:ring-[#d4a373]/40"
                            />
                        </label>
                        <button
                            type="submit"
                            class="w-full rounded-full bg-[#d4a373] px-4 py-2 text-sm font-semibold text-[#fefae0] transition hover:bg-[#c68d58]"
                        >
                            Subscribe
                        </button>
                    </form>
                </div>
            </div>
            <div class="border-t border-[#e9edc9]/80 bg-[#faedcd]">
                <div class="mx-auto flex max-w-6xl flex-col items-center justify-between gap-4 px-4 py-4 text-xs text-slate-600 md:flex-row md:px-6">
                    <p>© {new Date().getFullYear()} Fabric Loom Textiles Pvt. Ltd. All rights reserved.</p>
                    <div class="flex gap-4">
                        <a href="#" class="transition hover:text-[#d4a373]">Privacy</a>
                        <a href="#" class="transition hover:text-[#d4a373]">Terms</a>
                        <a href="#" class="transition hover:text-[#d4a373]">Sitemap</a>
                    </div>
                </div>
            </div>
        </footer>
        <script is:inline>
            (() => {
                const redirectToHomeOnReload = () => {
                    if (typeof window === "undefined") return false;
                    try {
                        const navigationEntry = performance.getEntriesByType?.("navigation")?.[0];
                        const navType = navigationEntry?.type ?? performance?.navigation?.type;
                        const reloadType = performance?.navigation?.TYPE_RELOAD;
                        const isReload = navType === "reload" || (typeof reloadType === "number" && navType === reloadType);

                        if (!isReload) {
                            sessionStorage.removeItem("fabric-home-reload-redirected");
                            return false;
                        }

                        if (window.location.pathname !== "/") {
                            window.location.replace("/");
                            return true;
                        }

                        const homeReloadKey = "fabric-home-reload-redirected";
                        if (!sessionStorage.getItem(homeReloadKey)) {
                            sessionStorage.setItem(homeReloadKey, "1");
                            window.location.replace("/");
                            return true;
                        }

                        sessionStorage.removeItem(homeReloadKey);
                    } catch {
                        // Ignore unsupported performance APIs
                    }
                    return false;
                };

                const ensureHomeLanding = () => {
                    if (typeof window === "undefined") return false;
                    try {
                        const storageKey = "fabric-landing-visited";
                        const isFirstVisit = !sessionStorage.getItem(storageKey);
                        if (isFirstVisit) {
                            sessionStorage.setItem(storageKey, "1");
                            if (window.location.pathname !== "/") {
                                window.location.replace("/");
                                return true;
                            }
                        }
                    } catch {
                        // Ignore storage errors (e.g., private mode restrictions)
                    }
                    return false;
                };

                if (redirectToHomeOnReload() || ensureHomeLanding()) {
                    return;
                }

                /** @type {HTMLElement | null} */
                const siteHeader = document.querySelector('[data-site-header]');
                if (siteHeader) {
                    siteHeader.removeAttribute("data-hidden");
                }

                // Make navbar transparent when hero section is in view
                const heroSection = document.querySelector('#hero');
                if (heroSection && siteHeader) {
                    const observer = new IntersectionObserver(
                        (entries) => {
                            entries.forEach(entry => {
                                if (entry.isIntersecting) {
                                    siteHeader.setAttribute('data-over-hero', 'true');
                                } else {
                                    siteHeader.removeAttribute('data-over-hero');
                                }
                            });
                        },
                        { threshold: 0.3, rootMargin: '0px 0px -50% 0px' }
                    );
                    observer.observe(heroSection);
                }

                const navToggle = document.querySelector("[data-nav-toggle]");
                const mobileMenu = document.querySelector("#mobile-menu");
                const searchToggleButtons = document.querySelectorAll("[data-search-toggle]");
                const searchPanel = document.querySelector("[data-search-panel]");
                const searchClose = document.querySelector("[data-search-close]");
                const searchInput = document.querySelector("[data-search-input]");
                const searchResults = document.querySelector("[data-search-results]");
                const quickLinks = [
                    { title: "Home", description: "Hero, collections, testimonials", href: "/" },
                    { title: "About", description: "Heritage, process, sustainability", href: "/about" },
                    { title: "Products", description: "Browse all fabrics and filter by occasion", href: "/products" },
                    { title: "Contact", description: "Request swatches or book a consultation", href: "/contact" },
                    { title: "Sweater Knits", description: "Soft merino and cashmere blends", href: "/products#category-sweaters" },
                    { title: "Casual Cottons", description: "Handloom cottons for everyday wear", href: "/products#category-casuals" },
                    { title: "Bridal Silks", description: "Heritage brocades and Banarasi weaves", href: "/products#category-traditionals" },
                    { title: "Artisanal Embroidery", description: "Handcrafted embellishments and panels", href: "/products#category-embroidery" },
                    { title: "Seasonal Collections", description: "Limited editions and exclusive collaborations", href: "/#seasonal-highlights" },
                ];

                if (navToggle && mobileMenu) {
                    navToggle.addEventListener("click", () => {
                        const isOpen = mobileMenu.classList.toggle("hidden");
                        navToggle.setAttribute("aria-expanded", (!isOpen).toString());
                    });
                }

                const closeSearchPanel = () => {
                    if (!searchPanel) return;
                    searchPanel.classList.add("invisible");
                    searchPanel.classList.add("opacity-0");
                    searchPanel.setAttribute("aria-hidden", "true");
                };

                const renderSearchResults = (term = "") => {
                    if (!searchResults) return;
                    const normalized = term.trim().toLowerCase();
                    const matches = normalized
                        ? quickLinks.filter(
                              (item) =>
                                  item.title.toLowerCase().includes(normalized) ||
                                  item.description.toLowerCase().includes(normalized)
                          )
                        : quickLinks.slice(0, 6);

                    const list = matches
                        .map(
                            (item) => `
                                <li>
                                    <a href="${item.href}" class="flex flex-col rounded-md border border-transparent px-3 py-2 transition hover:border-[#d4a373] hover:bg-[#fefae0]">
                                        <span class="text-sm font-semibold text-slate-800">${item.title}</span>
                                        <span class="text-xs text-slate-500">${item.description}</span>
                                    </a>
                                </li>
                            `
                        )
                        .join("");

                    searchResults.innerHTML = list || '<li class="px-3 py-2 text-xs text-slate-500">No matches yet. Try another phrase.</li>';
                };

                const openSearchPanel = () => {
                    if (!searchPanel) return;
                    searchPanel.classList.remove("invisible");
                    searchPanel.classList.remove("opacity-0");
                    searchPanel.classList.add("opacity-100");
                    searchPanel.setAttribute("aria-hidden", "false");
                    requestAnimationFrame(() => searchInput?.focus());
                    renderSearchResults("");
                };

                searchToggleButtons.forEach((btn) => btn.addEventListener("click", openSearchPanel));
                searchClose?.addEventListener("click", closeSearchPanel);
                searchInput?.addEventListener("input", (event) => renderSearchResults(event.target.value));

                document.addEventListener("keydown", (event) => {
                    if (event.key === "Escape") {
                        closeSearchPanel();
                    }
                });

                document.addEventListener("click", (event) => {
                    if (!(event.target instanceof Element)) {
                        return;
                    }
                    if (searchPanel && !searchPanel.contains(event.target) && !event.target.closest("[data-search-toggle]")) {
                        closeSearchPanel();
                    }
                });

                const animatedElements = Array.from(document.querySelectorAll("[data-animate]"));
                if ("IntersectionObserver" in window && animatedElements.length) {
                    const observer = new IntersectionObserver(
                        (entries, obs) => {
                            for (const entry of entries) {
                                if (entry.isIntersecting) {
                                    requestAnimationFrame(() => entry.target.setAttribute("data-animated", "true"));
                                    obs.unobserve(entry.target);
                                }
                            }
                        },
                        { threshold: 0.25, rootMargin: "0px 0px -20%" }
                    );

                    animatedElements.forEach((element, index) => {
                        const delay = Math.min(index * 120, 480);
                        element.style.setProperty("--animate-delay", `${delay}ms`);
                        observer.observe(element);
                    });
                } else {
                    animatedElements.forEach((element) => {
                        element.setAttribute("data-animated", "true");
                    });
                }
            })();
        </script>
    </body>
</html>

<style>
	html,
	body {
		margin: 0;
		width: 100%;
		height: 100%;
	}
</style>
